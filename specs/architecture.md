# アーキテクチャ仕様書

## システム概要

ディベートの論理構造ネストして理論構造を可視化する。
ノードの数が多くなればなるほどあらゆることで検証されているため情報が確かになる

## システムコンテキスト図

```mermaid
flowchart TD
    Browser["Web Browser\n(エンドユーザー/管理者インターフェース)"]
    CDN["CDN\n(将来的に導入)"]
    Frontend["フロントエンドアプリケーション\n(Remix + React + TypeScript)"]
    Backend["バックエンドAPI\n(Laravel)"]
    DB["データベース\n(MariaDB)"]
    External["外部サービス\n- 翻訳サービス\n- 学術検索エンジン\n- ファクトチェック"]
    
    Browser --> CDN
    CDN --> Frontend
    Frontend --> Backend
    Backend <--> External
    Backend --> DB
```

この図は、システムの主要コンポーネントとその相互関係を示しています。ユーザーはWebブラウザを通じてシステムにアクセスし、フロントエンドアプリケーションがバックエンドAPIと通信します。システムはまた、翻訳サービスや学術検索エンジンなどの外部サービスと連携し、機能を拡張します。

## 主機能

* 投稿システム
    * 「主張」「根拠」「論拠」のセット形式での投稿機能
    * 10種類の投稿形式（問題提示、問題分割、解決策提示、補足、要約、翻訳、推定、検証、倫理、論理的文章）
    * マルチメディア証拠（PDF、画像、音声、サイトURL、数式）のアップロード
    * センシティブフラグ設定
* 論理構造の可視化
    * ツリー状の議論構造表示
    * 多対多の関係性マッピング
    * 論理的繋がりの視覚化
* ユーザー認証・管理
    * アカウント作成と認証
    * 権限管理
    * ユーザープロファイル
* コンテンツモデレーション
    * 禁止事項（誹謗中傷等）の監視
    * センシティブコンテンツのフィルタリング
    * 証拠の集団検証システム
* 検索・ナビゲーション
    * 問題/解決策の検索
    * フィルタリング機能
    * トピック/カテゴリ分類
* インタラクション機能
    * 投稿への反応（評価等）
    * フォロー機能
    * シェア機能
    * 通知システム

## 機能要件 (システムが何をすべきか)

1. ユーザー管理

アカウント登録・ログイン機能
プロフィール設定・編集機能
ユーザー権限管理（一般ユーザー、モデレーター等）
アカウント認証（メール認証、2要素認証等）

2. 投稿システム

「主張」「根拠」「論拠」セットでの投稿作成
10種類の投稿形式選択（問題提示、問題分割、解決策提示、補足、要約、翻訳、推定、検証、倫理、論理的文章）
テキストエディタ（書式設定、数式入力機能）
下書き保存・編集機能
センシティブコンテンツ設定

3. マルチメディア管理

複数形式の証拠アップロード（PDF、画像、音声ファイル）
URLリンク添付機能（サイト魚拓）
数式エディタ・表示機能
メディアプレビュー機能

4. 議論構造化

ツリー表示機能
多対多関係の可視化
投稿間の関連付け機能
論理構造のグラフィカル表示

5. インタラクション

投稿へのリアクション機能
証拠の検証機能（複数ユーザーによる検証プロセス）
コメント・返信機能
投稿の保存・共有機能
シェア機能
質問形式の投稿促進
投稿のハードルを下げる機能

6. 検索・発見

高度な検索機能（キーワード、トピック、形式等）
フィルタリング・ソート機能
トレンド・人気投稿表示
関連投稿推薦機能

7. モデレーション

不適切コンテンツの報告機能
センシティブコンテンツのフラグ付け・フィルタリング
コンテンツ審査ワークフロー
違反ユーザーの管理機能

8. 通知・アラート

返信・リアクション通知
検証リクエスト通知
ニュースレター・ダイジェスト配信
イベント通知

9. 設定・カスタマイズ

センシティブコンテンツ表示設定
言語・ローカライゼーション設定
テーマ・レイアウト設定
通知設定

10. API・連携

外部サービス連携（検証ツール等）
データエクスポート機能
埋め込み共有機能
サードパーティ連携

11. 分析・レポート

議論の進行状況追跡
統計・インサイト表示
アクティビティログ
コミュニティ貢献度指標
倫理観の可視化・評価

12. セキュリティ・プライバシー

データ暗号化
プライバシー設定管理
セキュリティ監査ログ
GDPRなどの法令遵守機能

## 非機能要件

### パフォーマンス要件
* ページロード時間：2秒以内（95パーセンタイル）
* 大規模ツリー表示時のレンダリング最適化（1000ノード以上）
  * ズームレベルに応じたノード描画の最適化
  * ノード重要度計算の効率的なアルゴリズム実装
* レスポンス時間：API呼び出し200ms以内
* 同時接続ユーザー数：最大10,000ユーザー

### セキュリティ要件
* OWASP Top 10対策の実装
* データ暗号化（保存時と通信時）
* CSRF/XSS対策
* レート制限の実装
* ユーザーデータのアクセス制御

### アクセシビリティ
* WCAG 2.1 AA準拠
* 多言語対応（日英）
  * 投稿コンテンツは翻訳機能があるため、UIやシステムメッセージのみ多言語対応
* モバイルファーストデザイン
* 低速ネットワーク環境への最適化

## データアーキテクチャ

### 主要データモデル（ERD概略）

```mermaid
erDiagram
    User ||--o{ Post : creates
    User ||--o{ UserRole : has
    Post ||--o{ Relationship : has
    Post }o--o{ Community : belongs_to
    
    User {
        int id PK
        string name
        string email
        string password
        json profile
        json settings
        datetime created_at
        datetime updated_at
    }
    
    Post {
        int id PK
        int user_id FK
        int post_type_id
        string title
        text claim
        text evidence
        text reasoning
        boolean sensitivity
        datetime created_at
        datetime updated_at
    }
    
    Community {
        int id PK
        string name
        text description
        datetime created_at
        datetime updated_at
    }
    
    UserRole {
        int id PK
        int user_id FK
        int role_id FK
        datetime created_at
        datetime updated_at
    }
    
    Relationship {
        int id PK
        int from_post_id FK
        int to_post_id FK
        string relation_type
        datetime created_at
    }
    
    PostCommunity {
        int post_id FK
        int community_id FK
    }
```

### キャッシュ戦略

1. **フロントエンドキャッシュ**
   - React Query を使用したクライアントサイドキャッシング
   - Service Worker によるオフラインサポート（将来的に導入）

2. **バックエンドキャッシュ**
   - Redis キャッシュ（将来的に導入）
   - 頻繁にアクセスされる投稿やツリー構造のキャッシュ
   - 検索結果キャッシュ（15分有効）

3. **データベースクエリキャッシュ**
   - 複雑なクエリ結果のキャッシング（Laravel クエリキャッシュ）
   - 重要度計算指標のインデックス化と事前計算

### データフロー

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend API
    participant C as Cache
    participant DB as Database
    
    %% 投稿作成フロー
    U->>F: 投稿フォーム入力
    F->>F: バリデーション
    F->>B: API呼び出し
    B->>DB: データ保存
    B->>B: インデックス更新
    B->>C: キャッシュ無効化
    B->>F: 成功レスポンス
    F->>U: UI更新
```

#### 検索クエリフロー

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend API
    participant C as Cache
    participant DB as Database
    
    U->>F: 検索クエリ入力
    F->>B: API呼び出し
    B->>C: キャッシュチェック
    
    alt キャッシュヒット
        C->>B: キャッシュデータ返却
    else キャッシュミス
        B->>DB: DB検索
        DB->>B: 結果返却
        B->>C: キャッシュ更新
    end
    
    B->>F: 検索結果返却
    F->>U: 結果表示
```

#### 論理構造表示フロー

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend API
    participant C as Cache
    participant DB as Database
    
    U->>F: 論理構造表示リクエスト
    F->>B: GraphQLクエリ
    B->>C: キャッシュチェック
    
    alt キャッシュヒット
        C->>B: キャッシュデータ返却
    else キャッシュミス
        B->>DB: データ取得
        DB->>B: データ返却
        B->>B: 重要度計算
        B->>C: キャッシュ保存
    end
    
    B->>F: 構造データ返却
    F->>F: ズームレベルに応じた表示最適化
    F->>U: 論理構造表示
```

## モニタリングと運用

### ログ収集・分析

1. **アプリケーションログ**
   - Laravel ログシステムを使用
   - 重要なユーザーアクション、エラー、警告を記録
   - 構造化ロギング形式（JSON）の採用

2. **アクセスログ**
   - Laravel ミドルウェアを使用したアクセスログ記録（共有サーバーでNginxログにアクセスできないため）
   - ユーザーエージェント、IP、リクエストメソッド、URL、レスポンスコードの記録
   - ボット、クローラーの識別
   - 異常アクセスパターンの検出

3. **パフォーマンスメトリクス**
   - API応答時間の記録
   - DB操作時間の記録
   - 重いクエリのトラッキング

### 監視システム

1. **稼働監視**
   - Laravel スケジューラを使用した定期的なヘルスチェック
   - アプリケーションレベルでのリソース監視（共有サーバーのため直接的なサーバーリソース監視は制限あり）
   - 例外発生時の自動通知

2. **パフォーマンス監視**
   - ページロード時間の測定
   - API応答時間の測定
   - データベース負荷の監視
   - キャッシュヒット率の監視

3. **ユーザー体験監視**
   - リアルユーザーモニタリング（RUM）
   - エラー率の監視
   - フロントエンドパフォーマンス指標の収集

### インシデント対応

1. **アラート設定**
   - 異常検知時のEメール/Slack通知
   - エスカレーションフロー
   - オンコール体制（将来的に）

2. **トラブルシューティングガイド**
   - 一般的な問題に対する対応手順書
   - ログ分析ガイドライン
   - 緊急時のロールバック手順

## コンプライアンスと法的要件

### データプライバシー

1. **個人情報保護対策**
   - 個人情報の最小限の収集
   - 利用目的の明確化と同意取得
   - アクセス制御とデータ暗号化

2. **GDPR対応**
   - データポータビリティ（エクスポート機能）
   - 忘れられる権利（アカウント削除機能）
   - データ処理の記録

3. **Cookie ポリシー**
   - 必要最小限のCookie使用
   - オプトイン/オプトアウトの仕組み
   - 明確な通知と同意取得

### アクセシビリティコンプライアンス

1. **WCAG 2.1 AA準拠**
   - スクリーンリーダー対応
   - キーボードナビゲーション
   - コントラスト比の確保
   - 代替テキストの提供

2. **多言語対応**
   - UIとシステムメッセージの日英対応
   - 右から左への言語サポート（将来的に）

## 技術要件(システムがどのように実装されるか)

### 実装フェーズ

#### フェーズ1（MVP）
* 基本的なユーザー認証・管理
* 主要な投稿機能（問題提示、解決策提示、補足）
* 基本的な論理構造表示（シンプルなツリービュー）
* 基本検索・フィルタリング
* 最小限のモデレーション機能
* シンプルなUI（レスポンシブ対応）
* 管理者サイト基本機能

#### フェーズ2（拡張）
* 全10種類の投稿形式サポート
* 高度な論理構造可視化（ネットワークビュー）
* 信頼性スコアシステム
* コミュニティ機能
* 通知システム
* 高度なフィルタリング・検索機能

#### フェーズ3（完全版）
* AIアシスタント機能
* 時系列ビュー
* 高度なパーソナライゼーション
* コラボレーション機能
* 外部システム連携
* 高度なアクセシビリティ対応

## 重要アルゴリズム詳細

### ノード重要度計算アルゴリズム

```mermaid
flowchart TD
    A[投稿ノード] --> B{重要度計算}
    B --> C[基本スコア計算]
    B --> D[関連性スコア計算]
    B --> E[時間減衰係数計算]
    B --> V[検証スコア計算]
    B --> X[専門性評価ボーナス]
    B --> Y[いつくしみスコア]
    C --> F[最終重要度スコア]
    D --> F
    E --> F
    V --> F
    X --> F
    Y --> F
    
    subgraph basic["基本スコア計算"]
        C1["リアクション数 × 0.3"]
        C2["閲覧数 × 0.1"]
        C3["コメント数 × 0.2"]
    end
    
    subgraph relation["関連性スコア計算"]
        D1["被参照数 × 0.4"]
        D2["参照先の重要度 × 0.2"]
        D3["参照関係の種類による重み"]
    end
    
    subgraph verification["検証スコア計算"]
        V1["証拠検証スコア"]
        V2["論拠検証スコア"]
        V3["複数ユーザー検証ボーナス"]
        V4["関連性欠如ペナルティ"]
        V5["誤った主張ペナルティ"]
    end
    
    subgraph expertise["専門性評価ボーナス"]
        X1["専門家リアクション加重"]
        X2["専門家否定評価減点"]
    end
    
    subgraph ethics["いつくしみスコア（最重要）"]
        subgraph universal["普遍的倫理要素"]
            Y1["対話促進度評価"]
            Y2["危害防止性評価"]
            Y3["公平性評価"]
            Y4["透明性評価"]
        end
        subgraph cultural["文化特異的倫理要素"]
            Y5["文化固有価値評価"]
            Y6["地域別価値観適応"]
        end
    end
    
    subgraph time["時間減衰係数"]
        E1["exp(-0.05 × 経過日数)"]
    end
```

ノード重要度の計算式：

```
重要度 = (基本スコア + 関連性スコア + 検証スコア + 専門性評価ボーナス + いつくしみスコア × 2.0) × 時間減衰係数

基本スコア = (リアクション数 × 0.3) + (閲覧数 × 0.1) + (コメント数 × 0.2)

関連性スコア = (被参照数 × 0.4) + (参照先の重要度合計 × 0.2) + 関係種類ボーナス
  * 関係種類ボーナス: 補足=0.1, 検証=0.3, 反論=0.2, 要約=0.15

検証スコア = (証拠検証数 × 0.5) + (論拠検証数 × 0.5) + 複数ユーザー検証ボーナス - 関連性欠如ペナルティ - 誤った主張ペナルティ
  * 証拠検証数 = 証拠に対する検証投稿の数
  * 論拠検証数 = 論拠に対する検証投稿の数
  * 複数ユーザー検証ボーナス = min(検証したユニークユーザー数 × 0.25, 1.0)
    (異なるユーザーが多く検証するほど上限1.0までボーナス増加)
  * 関連性欠如ペナルティ = 関連性欠如フラグの有無 × 2.0
    (証拠が事実であっても主張や論拠との関連性が不十分と判断された場合に適用)
    (関連性欠如フラグが立つと検証スコアに大きなペナルティを課し、重要度を著しく下げる)
  * 誤った主張ペナルティ = 誤った主張フラグの有無 × 3.0
    (証拠や論拠が正確でも、それらから導かれる主張が論理的に誤っている場合に適用)
    (証拠と論拠から導かれない結論、論理的飛躍、因果関係の誤認などが該当)
    (誤った主張フラグが立つと検証スコアに最大級のペナルティを課し、重要度を最小化)

専門性評価ボーナス = 専門家肯定評価スコア - 専門家否定評価スコア
  * 専門家肯定評価スコア = Σ(肯定的リアクションを行った各ユーザーの専門性レベル × 0.2)
  * 専門家否定評価スコア = Σ(否定的リアクションを行った各ユーザーの専門性レベル × 0.3)
  * 専門性レベル = 分野別に自動計算されるユーザーの信頼性スコア（1〜5）
    - レベル1: 一般ユーザー（重み×1）- システム登録時の初期レベル
    - レベル2: 分野貢献者（重み×2）- 特定分野での貢献開始が認められたレベル
    - レベル3: 分野専門家（重み×3）- 多数の有益な貢献実績があるレベル
    - レベル4: 信頼専門家（重み×4）- 高い検証精度と信頼性が確立されたレベル
    - レベル5: 分野権威者（重み×5）- 卓越した貢献と影響力を持つレベル

### ユーザー専門性レベル算出システム

各分野（数学、物理学、医学、経済学など）ごとに独立して専門性レベルが計算されます。

```
分野別専門性スコア = (貢献投稿スコア × 0.3) + (検証精度スコア × 0.4) + (ピア評価スコア × 0.3)
```

1. **貢献投稿スコア**: 分野内での投稿数と質に基づく評価
   * 投稿数: 特定分野に関連した投稿回数
   * 投稿品質: 各投稿の重要度スコア平均値
   * 閾値: 50点で最大値到達、レベル向上に必要なベース点数

2. **検証精度スコア**: 検証活動の正確性に基づく評価
   * 検証正確率: (正確な検証数) ÷ (総検証数)
   * 検証量: 特定分野での総検証活動数
   * 検証合意度: 他のユーザーによる再検証での合意率
   * 閾値: 検証数30件以上かつ正確率85%以上で最大値

3. **ピア評価スコア**: 他の専門家からの評価に基づく評価
   * 高レベルユーザーからの承認: レベル4以上のユーザーからの肯定的評価
   * 専門家間合意: 同分野の他専門家との評価一致率
   * ピア引用: 他ユーザーの投稿から参照された回数
   * 閾値: 高レベルユーザー10人以上の肯定評価で最大値

専門性レベルの決定:
* レベル1 (0-20点): 初期ユーザー
* レベル2 (21-40点): 一定の貢献と正確性を示したユーザー
* レベル3 (41-60点): 優れた貢献と高い正確性を示したユーザー
* レベル4 (61-80点): 持続的な優れた貢献と高い信頼性を確立したユーザー
* レベル5 (81-100点): 最高レベルの貢献と信頼性を達成したユーザー

注: レベル4および5への昇格には、自動評価に加えて分野専門家パネルによるレビューが必要

いつくしみスコア = (普遍的倫理要素 × 0.7) + (文化特異的倫理要素 × 0.3)

普遍的倫理要素 = (対話促進度 + 危害防止性 + 公平性 + 透明性) / 4
  * 対話促進度: 建設的な対話を促す度合い（0〜1）
    - 他者の視点を尊重し、対話を奨励する内容ほど高スコア
    - 敵対的・分断的な表現を避けた提案ほど高スコア
  * 危害防止性: 害を与えず安全性を確保する度合い（0〜1）
    - 身体的・精神的被害を防止・軽減する内容ほど高スコア
    - 脆弱な立場の人々を保護する提案ほど高スコア
  * 公平性: 基本的な公正さの度合い（0〜1）
    - 明らかな差別や偏見がない説明ほど高スコア
    - 機会の平等を考慮した提案ほど高スコア
  * 透明性: 情報開示と誠実さの度合い（0〜1）
    - 情報源や前提条件を明示した内容ほど高スコア
    - 利益相反や限界を正直に開示した提案ほど高スコア

文化特異的倫理要素 = ユーザー設定や地域に基づき以下から適切に組み合わせ
  * 集団調和: 集団の和を重んじる文化での評価（日本など）
    - 集団の調和を維持・促進する内容ほど高スコア
    - 合意形成を促す提案ほど高スコア
  * 個人自律: 個人の自由を重んじる文化での評価（欧米など）
    - 個人の選択権を尊重する内容ほど高スコア
    - 自己決定を支援する提案ほど高スコア
  * 家族価値: 家族を重視する文化での評価
    - 家族の絆を強化する内容ほど高スコア
    - 世代間の尊重を促す提案ほど高スコア
  * 宗教的調和: 宗教的多様性のある地域での評価
    - 宗教間の相互理解を促進する内容ほど高スコア
    - 信仰の自由を尊重する提案ほど高スコア

注：
  1. いつくしみスコアは倫理委員会と多様な文化背景を持つ評価者によるレビューを組み合わせて算出
  2. ユーザーは自分の文化的背景や価値観に基づき、文化特異的要素の重みをカスタマイズ可能
  3. 地域ごとにローカライズされた評価基準を開発・適用（日本版、米国版、欧州版など）

時間減衰係数 = exp(-0.05 × 経過日数)
```

### 将来追加予定の重要度計算要素

システムの進化と共に、以下の要素を重要度計算に段階的に追加することを検討します：

1. **オリジナリティスコア**
   * 新規性: 既存投稿との類似性分析に基づく独自視点の評価
   * アイデア革新性: 従来にない発想や解決策の評価
   * 計算方法: 自然言語処理による意味的重複検出と独自性の数値化

2. **根拠品質スコア**
   * 引用品質: 学術論文、一次資料など高信頼情報源の評価
   * 引用多様性: 複数の独立した情報源からの裏付け度合い
   * 引用検証度: 引用内容の正確性と適切性の評価

3. **コミュニティ関連性**
   * コミュニティスコア: 特定コミュニティ内での関心度・重要性
   * パーソナライズド重要度: ユーザーの関心領域に基づく調整
   * トピック関連度: 特定のトピックにおける中心性の評価

4. **議論促進度**
   * 議論分岐度: 投稿から発展した有意義な議論の広がり
   * 意見多様性促進: 多様な視点を引き出した程度
   * 解決貢献度: 問題解決や意見集約への貢献度

5. **情報網羅性**
   * 包括性: 論点・側面の網羅度
   * 多角的視点: 異なる立場からの検討度合い
   * 情報粒度: 適切な詳細レベルの提供度

これらの要素は、システムの発展段階や利用状況に応じて優先順位を決定し、ユーザーフィードバックを基に段階的に実装します。各要素の正確な計算方法と重み付けは、初期データ分析と実際の使用パターンに基づいて調整します。

### ズームレベル対応表示アルゴリズム

```mermaid
flowchart TD
    A["現在のズームレベル"] --> B{"閾値判定"}
    B -->|"ズームレベル > 0.8"| C["すべてのノード表示"]
    B -->|"0.5 < ズームレベル <= 0.8"| D["重要度上位50%のノード表示"]
    B -->|"0.3 < ズームレベル <= 0.5"| E["重要度上位25%のノード表示"]
    B -->|"ズームレベル <= 0.3"| F["重要度上位10%のノード表示"]
    
    C --> G["ノードサイズ計算"]
    D --> G
    E --> G
    F --> G
    
    G -->|"詳細レベル = 最高"| H1["すべての属性表示"]
    G -->|"詳細レベル = 中"| H2["タイトルと種類のみ表示"]
    G -->|"詳細レベル = 低"| H3["タイトルのみ表示"]
```

実装アルゴリズム詳細：

1. 現在表示されているツリーのすべてのノードの重要度をソート
2. ズームレベルに基づいて表示するノードの割合を決定
3. ノードの表示サイズは重要度に比例（最低サイズと最大サイズの範囲内）
4. 詳細レベルはズームレベルと相関：
   - 高ズームレベル：タイトル、投稿種類、作成者、日付、リアクション数を表示
   - 中ズームレベル：タイトルと投稿種類のみ表示
   - 低ズームレベル：タイトルのみ表示（一定文字数で切り捨て）

### 検索アルゴリズム

1. **複合検索スコアリング**
   - タイトル一致：×3.0の重み
   - 主張内容一致：×2.0の重み
   - 根拠・論拠一致：×1.5の重み
   - タグ一致：×1.2の重み
   - コメント内容一致：×0.8の重み

2. **関連性フィードバック**
   - ユーザーの検索履歴から学習
   - クリックされた検索結果の特性を強化
   - 共起語の関連度学習（将来的な機能）

3. **検索最適化**
   - インデックス最適化：タイトル、主張、タグのインデックス作成
   - 部分一致、あいまい検索のサポート
   - 日本語形態素解析による検索精度向上

## セキュリティアーキテクチャ

### 認証フロー

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant A as Auth Service
    participant B as Backend API
    participant DB as Database
    
    %% ログインフロー
    U->>F: ログイン情報入力
    F->>A: 認証リクエスト
    A->>DB: ユーザー情報検証
    DB->>A: 検証結果
    
    alt 認証成功
        A->>A: JWT生成
        A->>F: JWT返却
        F->>F: JWTをlocalStorageに保存
        F->>U: ログイン成功表示
    else 認証失敗
        A->>F: エラー返却
        F->>U: エラー表示
    end
    
    %% API利用フロー
    U->>F: API操作リクエスト
    F->>F: JWTをヘッダーに添付
    F->>B: APIリクエスト
    B->>B: JWT検証
    
    alt JWT有効
        B->>DB: データ取得/更新
        DB->>B: 結果
        B->>F: レスポンス
        F->>U: 結果表示
    else JWT無効
        B->>F: 認証エラー
        F->>A: リフレッシュトークン使用
        alt リフレッシュ成功
            A->>F: 新JWT
            F->>B: リトライ
        else リフレッシュ失敗
            F->>U: 再ログイン要求
        end
    end
```

### パスワード管理

1. **ハッシュ化**
   - Laravelの標準ハッシュ機能（Bcrypt）使用
   - ペッパー付きハッシュの実装（追加セキュリティ）

2. **パスワードポリシー**
   - 最低8文字、英数字記号混合
   - よくあるパスワード辞書チェック
   - 過去使用したパスワード再利用防止

3. **多要素認証（管理者用）**
   - メール/SMSによるワンタイムパスワード
   - 認証アプリ（Google Authenticator等）サポート

### データ保護

1. **保存データ暗号化**
   - センシティブデータのカラムレベル暗号化
   - Laravel Encryptionファサードの活用
   - 暗号化キーのローテーション計画

2. **通信暗号化**
   - TLS 1.3強制
   - HSTS（HTTP Strict Transport Security）の実装
   - 証明書の自動更新システム

3. **セキュリティヘッダー**
   - Content-Security-Policy実装
   - X-XSS-Protection設定
   - X-Frame-Options: DENY設定

### 権限管理システム

```mermaid
classDiagram
    class User {
        +id
        +email
        +password
        +getRoles()
        +hasPermission()
    }
    
    class Role {
        +id
        +name
        +description
        +getPermissions()
    }
    
    class Permission {
        +id
        +name
        +description
        +resource
        +action
    }
    
    class Resource {
        +id
        +name
        +type
    }
    
    User "1" *-- "n" Role : has
    Role "1" *-- "n" Permission : includes
    Permission "n" -- "1" Resource : controls
```

1. **ロールベースの権限システム**
   - 事前定義ロール：一般ユーザー、モデレーター、管理者、システム管理者
   - カスタムロール作成機能（将来的に）
   - リソースごとのきめ細かい権限設定

2. **アクセス制御ロジック**
   - ミドルウェアによる認可チェック
   - ポリシーとゲートの活用（Laravel標準機能）
   - リソースごとの所有者チェック

## スケーラビリティ設計

### 負荷対策

1. **水平スケーリングポイント**
   - Webサーバー層：複数インスタンス配置（将来的に）
   - キャッシュ層：Redis分散構成
   - データベース：読み取りレプリカ（将来的に）

2. **パフォーマンスボトルネック対策**
   - 複雑なクエリの事前キャッシュ
   - 重要度計算の非同期バッチ処理化
   - 大規模ツリーの部分読み込み実装

3. **段階的スケールアウト計画**
   - 1万ユーザー：単一サーバー＋キャッシュ強化
   - 5万ユーザー：読み取りレプリカ導入
   - 10万ユーザー：サービス分離とロードバランサー導入

### トラフィック管理

1. **レートリミット実装**
   - 匿名ユーザー：1分間に30リクエスト
   - 認証済みユーザー：1分間に60リクエスト
   - API利用者：1分間に120リクエスト（トークンベース）

2. **コネクション管理**
   - データベースコネクションプール
   - クエリタイムアウト設定（30秒）
   - 長時間クエリの監視と最適化

3. **非同期処理**
   - 投稿インデックス更新の非同期処理
   - 通知送信のキュー処理
   - 重要度再計算のバッチ処理

### データ成長対策

1. **パーティショニング戦略**
   - 投稿テーブル：日付ベースのパーティショニング
   - アクセスログ：月次パーティショニング
   - 古いデータのアーカイブポリシー

2. **インデックス戦略**
   - 複合インデックスの最適化
   - 検索クエリ向けの特殊インデックス
   - インデックスメンテナンス計画

## 実装優先順位

### 優先度評価マトリックス

| 機能 | ビジネス重要度 | 技術的複雑さ | 実装難易度 | 優先度 |
|------|--------------|------------|-----------|-------|
| ユーザー認証 | 高 | 低 | 低 | P0 |
| 基本投稿機能 | 高 | 中 | 中 | P0 |
| 基本ツリー表示 | 高 | 高 | 高 | P0 |
| 検索機能 | 高 | 中 | 中 | P1 |
| 投稿形式の全種類対応 | 中 | 低 | 低 | P1 |
| ネットワークビュー | 中 | 高 | 高 | P2 |
| ズームレベル対応表示 | 中 | 高 | 高 | P2 |
| 信頼性スコア | 中 | 中 | 中 | P2 |
| 多言語対応 | 低 | 中 | 中 | P3 |
| AIアシスタント | 低 | 高 | 高 | P3 |

### 実装スケジュール

#### フェーズ1（MVP）- 3ヶ月
1. ユーザー認証・管理システム - 2週間
2. 基本投稿機能（3種類） - 3週間
3. シンプルなツリービュー - 4週間
4. 基本検索・フィルタリング - 2週間
5. 最小限モデレーション - 1週間
6. テスト・バグ修正 - 2週間

#### フェーズ2（拡張）- 4ヶ月
1. 残りの投稿形式実装 - 3週間
2. ネットワークビュー実装 - 5週間
3. 信頼性スコアシステム - 3週間
4. コミュニティ機能 - 3週間
5. 通知システム - 2週間
6. 高度検索機能 - 2週間
7. テスト・最適化 - 2週間

#### フェーズ3（完全版）- 5ヶ月
1. AIアシスタント統合 - 6週間
2. 時系列ビュー - 4週間
3. パーソナライゼーション - 3週間
4. コラボレーション機能 - 4週間
5. 外部システム連携 - 3週間
6. アクセシビリティ強化 - 2週間
7. 最終テスト・最適化 - 2週間

### 技術的リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| 大規模ツリー表示の性能問題 | 高 | 高 | 部分読み込み、WebGL採用、サーバーサイドレンダリング検討 |
| 複雑な関係性クエリのパフォーマンス | 高 | 中 | クエリ最適化、キャッシュ強化、インデックス設計見直し |
| モバイル端末での表示問題 | 中 | 高 | モバイルファーストデザイン、レスポンシブテスト強化 |
| レンタルサーバー制限への抵触 | 高 | 中 | リソース使用量監視、段階的なスケールアウト計画 |
| データ整合性問題 | 中 | 低 | トランザクション制御強化、整合性テスト追加 |

### フロントエンド
    * Remix (Reactフレームワーク)
    * React
    * Ant Design (ReactのUIコンポーネントライブラリ)
    * TypeScript
    * TailwindCSS
    * 多言語対応（UIやシステムメッセージのみ、投稿コンテンツは翻訳機能で対応）

### 管理者フロントエンド
    * 別SPAとして実装
    * React
    * Ant Design Pro (管理者向けUIコンポーネント)
    * TypeScript
    * 独立したデプロイとホスティング
    * 別ドメインまたはサブドメインでの提供
    * 専用の認証システム（多要素認証対応）

### バックエンド

フレームワーク Laravel 12.x

データベース MariaDB 10.5.x

### サーバー

xserver(レンタルサーバー)

使用可能なミドルウェア nginx PHP8 Cron

## 開発・運用ライフサイクル

### 開発環境

1. **ローカル開発環境**
   - Docker開発環境
   - 開発用データベース (SQLite/MariaDB)
   - Hot Reloading対応

2. **開発プロセス**
   - GitHubフローによるブランチ管理
   - プルリクエストと強制的なコードレビュー
   - 自動テスト実行（GitHub Actions）

### テスト戦略

1. **ユニットテスト**
   - PHPUnit（Laravel）
   - Jest（React/TypeScript）
   - ビジネスロジックの網羅的テスト

2. **統合テスト**
   - API統合テスト（エンドポイントごと）
   - フロントエンドコンポーネントテスト
   - データフローの検証

3. **E2Eテスト**
   - Cypress を使用したブラウザテスト
   - 主要ユーザーフロー（登録・投稿・検索）の検証
   - レスポンシブデザインの検証

4. **パフォーマンステスト**
   - API負荷テスト
   - 大規模データセットでの可視化テスト
   - ブラウザパフォーマンス計測

### デプロイメント

1. **ステージング環境**
   - 本番環境レプリカでのプレリリーステスト
   - 手動QA検証
   - ステークホルダーデモ

2. **本番環境デプロイプロセス**
   - Gitタグベースのリリースフロー
   - ブルー/グリーンデプロイメント（将来的に）
   - ゼロダウンタイムデプロイ（可能な限り）

3. **リリース後監視**
   - デプロイ直後の重点的モニタリング
   - カナリアテスト（一部ユーザーへの段階的ロールアウト）
   - 緊急ロールバック手順

#### 使用するAPIパターン

RESTful API:
    投稿の作成・更新・削除
    ユーザー管理
    マルチメディア管理
    管理者API（別途認証と権限管理）

GraphQL:
    投稿の取得
    複雑な論理構造と多対多の関係性の取得に最適
    クライアントが必要なデータだけを正確に取得できる（オーバーフェッチングの回避）
    ツリー状の議論構造や関連投稿を効率的に一度のリクエストで取得

Webhook(保留):
    アプリを作成する際に追加予定
    リアルタイム通知（新しい返信、検証結果など）に利用

WebSocketの導入(保留):
    リアルタイムの議論状況や協調編集機能のサポート
    複数ユーザーによるリアルタイム検証作業に有効



